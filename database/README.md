# 启明星平台数据库设置指南

## 概述

本文档提供了启明星平台完整数据库结构的设置指南。数据库设计基于产品需求文档(PRD)，包含用户管理、OKR目标管理、学习活动跟踪、AI聊天记录、课程管理等核心功能模块。

## 数据库架构

### 核心表结构

| 表名 | 描述 | 主要功能 |
|------|------|----------|
| `users` | 用户基础信息表 | 存储学生、教师、管理员的基本信息 |
| `roles` | 角色权限表 | 定义系统中的角色和权限 |
| `user_roles` | 用户角色关联表 | 管理用户与角色的多对多关系 |
| `okrs` | OKR目标表 | 存储个人、课程、学院层面的目标 |
| `key_results` | 关键结果表 | 存储OKR的具体可衡量结果 |
| `learning_activities` | 学习活动表 | 记录各类学习行为和成果 |
| `chat_sessions` | 聊天会话表 | AI助手对话会话管理 |
| `chat_messages` | 聊天消息表 | 存储具体的对话消息 |
| `courses` | 课程表 | 课程基础信息管理 |
| `enrollments` | 选课表 | 学生选课和成绩管理 |

### 数据库特性

- **UUID主键**: 所有表使用UUID作为主键，确保全局唯一性
- **时间戳**: 自动维护创建时间和更新时间
- **约束检查**: 使用CHECK约束确保数据完整性
- **外键关联**: 完整的表间关系和级联删除
- **索引优化**: 针对查询场景优化的索引设计
- **行级安全**: RLS策略保护用户数据隐私
- **JSONB支持**: 灵活的元数据和权限存储

## 设置步骤

### 方法一：Supabase Dashboard SQL编辑器（推荐）

1. **访问Supabase Dashboard**
   ```
   https://sxhfiadommaopzoigtbz.supabase.co/project/sxhfiadommaopzoigtbz/sql
   ```

2. **执行SQL脚本**
   - 打开 `database/supabase-setup.sql` 文件
   - 复制全部内容到SQL编辑器
   - 点击「Run」按钮执行

3. **验证创建结果**
   - 检查表是否成功创建
   - 确认索引和触发器设置
   - 验证初始数据插入

### 方法二：使用Node.js脚本

```bash
# 在项目根目录执行
node scripts/setup-database.js
```

**注意**: 此方法需要配置正确的环境变量和访问权限。

## 数据库配置信息

- **项目URL**: `https://sxhfiadommaopzoigtbz.supabase.co`
- **项目ID**: `sxhfiadommaopzoigtbz`
- **配置文件**: `doc/evn.txt`

## 功能模块说明

### 1. 用户管理模块

- **用户表 (users)**: 支持学生、教师、管理员三种角色
- **角色表 (roles)**: 基于JSONB的灵活权限系统
- **用户角色关联 (user_roles)**: 支持用户多角色分配

### 2. OKR管理模块

- **目标层次**: 支持个人、课程、学院三个层级
- **进度跟踪**: 百分比进度和状态管理
- **关键结果**: 多种衡量类型（数值、布尔、百分比）

### 3. 学习活动模块

- **活动类型**: 学习、项目、作业、考试、讨论、阅读
- **难度等级**: 1-5级难度分类
- **标签系统**: JSONB存储的灵活标签
- **元数据**: 扩展信息存储

### 4. AI聊天模块

- **会话管理**: 支持多种对话类型
- **AI代理**: 学生助手、教师助手、学院助手
- **消息存储**: 完整的对话历史记录
- **性能监控**: 响应时间和token使用统计

### 5. 课程管理模块

- **课程信息**: 完整的课程元数据
- **选课管理**: 学生选课和退课
- **成绩管理**: 等级制和绩点制并存
- **教学大纲**: JSONB存储的结构化大纲

## 安全策略

### 行级安全策略 (RLS)

- **数据隔离**: 用户只能访问自己的数据
- **权限控制**: 基于认证用户ID的访问控制
- **级联权限**: 关联表的权限继承

### 数据保护

- **密码安全**: 密码哈希存储
- **敏感信息**: 个人信息访问限制
- **审计日志**: 创建和更新时间记录

## 扩展性设计

### 水平扩展

- **UUID主键**: 支持分布式环境
- **JSONB字段**: 灵活的schema演进
- **索引优化**: 支持大数据量查询

### 功能扩展

- **元数据字段**: 预留扩展信息存储
- **标签系统**: 灵活的分类和标记
- **权限系统**: 可配置的角色权限

## 维护建议

### 定期维护

1. **索引优化**: 根据查询模式调整索引
2. **数据清理**: 定期清理过期数据
3. **性能监控**: 监控慢查询和资源使用

### 备份策略

1. **自动备份**: 启用Supabase自动备份
2. **定期导出**: 重要数据定期导出
3. **恢复测试**: 定期测试数据恢复流程

## 故障排除

### 常见问题

1. **权限错误**: 检查RLS策略配置
2. **外键约束**: 确保关联数据存在
3. **唯一约束**: 检查重复数据插入

### 调试工具

- **Supabase Dashboard**: 表结构和数据查看
- **SQL编辑器**: 直接SQL查询调试
- **日志查看**: 错误日志分析

## 联系支持

如遇到数据库相关问题，请检查：
1. SQL脚本执行日志
2. Supabase项目设置
3. 网络连接状态
4. 访问权限配置

---

**版本**: v1.0  
**更新时间**: 2024年1月  
**维护者**: 启明星平台开发团队